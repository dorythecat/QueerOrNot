<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queer or Not? | Game</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script type="text/javascript" src="script.js" defer></script>
  </head>

  <body>
    <a class="mainpage" style="float:none" href="index.html">Queer or Not?</a>

    <div class="game active">
      <h1>Are you queer?</h1>
      <button onclick="startGame(true)">Yes</button>
      <button onclick="startGame(false)">No</button>
    </div>

    <div class="game waiting">
      <div class="loader"></div>
    </div>

    <div class="game inactive">
      <ul id="messages"></ul>
      <form id="chatform" action="javascript:void(0);">
        <input id="chatinput" type="text" autocomplete="off" placeholder="Type your answer here..." required />
        <button>Send</button>
      </form>
    </div>

    <div class="game result inactive">
      <h1>Was your partner queer?</h1>
      <button onclick="endGame(true)">Yes</button>
      <button onclick="endGame(false)">No</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      let cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [name, value] = cookie.trim().split('=');
        acc[name] = value;
        return acc;
      }, {});
      if (cookies.queer) {
        const activeElement = document.getElementsByClassName('game active')[0];
        const waitingElement = document.getElementsByClassName('game waiting')[0];
        if (activeElement) {
          activeElement.classList.remove('active');
          activeElement.classList.add('inactive');
        }
        if (waitingElement) {
          waitingElement.classList.add('active');
        }
      }

      var socket = io(window.location.host, {
        reconnectionDelayMax: 10000,
        query: {
          isQueer: cookies.queer === 'true'
        }
      });

      var form = document.getElementById('chatform');
      var input = document.getElementById('chatinput');

      var lastMessage = '';

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        // No need to check if input is empty, as the input field is required
        socket.emit('chat message', input.value);
        lastMessage = input.value;

        var item = document.createElement('li');
        item.id = 'own';
        item.textContent = input.value;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);

        input.value = '';
      });

      socket.on('chat message', function(msg, isQueer) {
        if (msg === lastMessage) { // Ignore messages we've just sent
          lastMessage = '';
          return;
        }
        var item = document.createElement('li');
        item.textContent = msg;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);

        console.log('Received message:', msg, 'Is queer:', isQueer);
      });

      socket.on('pair', function(pair) {
        const waitingElement = document.getElementsByClassName('game waiting')[0];
        const inactiveElement = document.getElementsByClassName('game inactive')[1];
        if (waitingElement) {
          waitingElement.classList.remove('active');
          waitingElement.classList.add('inactive');
        }

        if (inactiveElement) {
          inactiveElement.classList.remove('inactive');
          inactiveElement.classList.add('active');
        }
      });

      socket.on('unpair', function() {
        const activeElement = document.getElementsByClassName('game active')[0];
        const resultElement = document.getElementsByClassName('game result')[0];

        if (activeElement) {
          activeElement.classList.remove('active');
          activeElement.classList.add('inactive');
        }
        if (resultElement) {
          resultElement.classList.remove('inactive');
          resultElement.classList.add('active');
        }

        messages.innerHTML = ''; // Clear chat messages
      });

      function endGame(isQueer) {
        if (isQueer === (cookies.queer === 'true')) {
          alert('You guessed correctly!');
        } else {
          alert('You guessed wrong!');
        }
        reload();
      }
    </script>
  </body>
</html>
