<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queer or Not? | Game</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
  </head>

  <body>
    <a class="mainpage" style="float:none" href="index.html">Queer or Not?</a>

    <div class="game active">
      <h1>Are you queer?</h1>
      <button onclick="startGame(true)">Yes</button>
      <button onclick="startGame(false)">No</button>
    </div>

    <div class="game waiting">
      <div class="loader"></div>
    </div>

    <div class="game inactive">
      <button class="report" onclick="report()">Report</button>
      <ul id="messages"></ul>
      <form id="chatform" action="javascript:void(0);">
        <input id="chatinput" type="text" autocomplete="off" placeholder="Type your answer here..." required />
        <button>Send</button>
      </form>
    </div>

    <div class="game result inactive">
      <h1>Was your partner queer?</h1>
      <button onclick="endGame(true)">Yes</button>
      <button onclick="endGame(false)">No</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      let cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [name, value] = cookie.trim().split('=');
        acc[name] = value;
        return acc;
      }, {});
      if (cookies.queer) {
        const activeElement = document.getElementsByClassName('game active')[0];
        const waitingElement = document.getElementsByClassName('game waiting')[0];
        if (activeElement) {
          activeElement.classList.remove('active');
          activeElement.classList.add('inactive');
        }
        if (waitingElement) waitingElement.classList.add('active');
      }

      var socket = io(window.location.host, {
        reconnectionDelayMax: 10000,
        query: {
          isQueer: cookies.queer === 'true'
        }
      });

      if (cookies.queer) socket.emit('pair');

      var form = document.getElementById('chatform');
      var input = document.getElementById('chatinput');

      var lastMessage = '';

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        // No need to check if input is empty, as the input field is required
        socket.emit('chat message', input.value);
        lastMessage = input.value;

        let item = document.createElement('li');
        item.id = 'own';
        item.textContent = input.value;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);

        input.value = '';
      });

      socket.on('chat message', function(msg, isQueer) {
        if (msg === lastMessage) { // Ignore messages we've just sent
          lastMessage = '';
          return;
        }
        let item = document.createElement('li');
        item.textContent = msg;
        messages.appendChild(item);

        console.log('Received message:', msg, 'Is queer:', isQueer);
      });

      socket.on('pair', function(pair) {
        const waitingElement = document.getElementsByClassName('game waiting')[0];
        const inactiveElement = document.getElementsByClassName('game inactive')[1];
        if (waitingElement) {
          waitingElement.classList.remove('active');
          waitingElement.classList.add('inactive');
        }

        if (inactiveElement) {
          inactiveElement.classList.remove('inactive');
          inactiveElement.classList.add('active');
        }
      });

      socket.on('unpair', function() {
        const activeElement = document.getElementsByClassName('game active')[0];
        const resultElement = document.getElementsByClassName('game result')[0];

        if (activeElement) {
          activeElement.classList.remove('active');
          activeElement.classList.add('inactive');
        }
        if (resultElement) {
          resultElement.classList.remove('inactive');
          resultElement.classList.add('active');
        }

        messages.innerHTML = ''; // Clear chat messages
      });

      function startGame(isQueer) {
        const activeElement = document.getElementsByClassName("game active")[0];
        const waitingElement = document.getElementsByClassName("game waiting")[0];
        if (activeElement) {
          activeElement.classList.remove("active");
          activeElement.classList.add("inactive");
        }
        if (waitingElement) waitingElement.classList.add("active");

        document.cookie = "queer=" + (isQueer ? "true" : "false");
        socket.emit('pair');
      }

      function endGame(isQueer) {
        alert('You guessed ' + (isQueer === (cookies.queer === 'true') ? 'correctly' : 'wrong') + '!');
        window.location.reload();
      }

      function report() {
        const reportText = prompt("Please enter your report:");
        if (reportText) {
          socket.emit('report', reportText);
          alert("Thank you for your report!");
        } else alert("Report cancelled.");
      }
    </script>
  </body>
</html>
